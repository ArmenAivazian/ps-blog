---
import BaseHead from "../../components/BaseHead.astro";
import { SITE_DESCRIPTION } from "../../config";
import Header from "../../components/Header/Header.astro";
import { Resources } from "../../constants/resources";

interface Category {
  name: string;
  slug: string;
  description: string;
  posts: {
    slug: string;
    title: string;
    createdAt: string;
    excerpt: string;
    coverImage: {
      url: string;
    };
  }[];
}

interface CategoriesData {
  data: {
    categories: Category[];
  };
}

export async function getStaticPaths() {
  const response = await fetch(import.meta.env.HYGRAPH_KEY, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Accept: "application/json",
    },
    body: JSON.stringify({
      query: `
    {
      categories {
        name
        slug
        description
        posts {
          slug
          title
          excerpt
          createdAt
          coverImage {
            url
          }
        }
      }
    }
      `,
    }),
  });
  const categories = (await response.json()) as CategoriesData;

  return categories.data.categories.map(
    ({ slug, name, description, posts }) => {
      return {
        params: { slug },
        props: { name, description, posts },
      };
    }
  );
}

const { name, description, posts } = Astro.props as Category;
---

<html>
  <head>
    <BaseHead description={SITE_DESCRIPTION} />
  </head>
  <body class="flex flex-col h-screen bg-white text-gray-800 break-words">
    <Header />
    <main class="mx-7 lg:mx-6 mt-5 lg:mt-10 flex-grow">
      <div class="max-w-5xl mx-auto">
        <div class="mb-8 text-center">
          <h1 class="text-4xl font-medium leading-normal mt-0">{name}</h1>
        </div>
        <div class="mb-2 text-gray-500 text-xm">
          {description}
        </div>
        <div class="flex flex-wrap -mx-2">
          {
            posts.map(({ coverImage, title, createdAt, excerpt, slug }) => (
              <div class="w-full sm:w-1/2 md:w-1/3 self-stretch p-2 mb-2">
                <div class="rounded shadow-md h-full">
                  <a href="/much-to-do/">
                    <img
                      class="w-full m-0 rounded-t lazy"
                      src={coverImage.url}
                      width="960"
                      height="500"
                      alt={title}
                    />
                  </a>
                  <div class="px-6 py-5 ">
                    <div class="font-semibold text-lg mb-2">
                      <a
                        class="text-gray-900 hover:text-gray-700 h-14 overflow-hidden text-ellipsis"
                        href={`${Resources.Post}${slug}`}
                        style={{
                          display: "-webkit-box",
                          ["-webkit-line-clamp"]: 2,
                          ["-webkit-box-orient"]: "vertical",
                        }}
                      >
                        {title}
                      </a>
                    </div>
                    <p
                      class="text-gray-700 mb-2 text-sm"
                      title="Published date"
                    >
                      {new Date(createdAt).toLocaleString()}
                    </p>
                    <p
                      class="text-gray-800 overflow-hidden max-h-24 text-ellipsis"
                      style={{
                        display: "-webkit-box",
                        ["-webkit-line-clamp"]: 4,
                        ["-webkit-box-orient"]: "vertical",
                      }}
                    >
                      {excerpt}
                    </p>
                  </div>
                </div>
              </div>
            ))
          }
        </div>
      </div>
    </main>
  </body>
</html>
